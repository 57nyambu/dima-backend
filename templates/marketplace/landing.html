{% extends "base.html" %}
{% load static %}
<style>
    /* Cart and notification animations */
    @keyframes cartBounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
    }

    .animate-bounce {
        animation: cartBounce 0.5s ease-in-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        // Wait for DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
    
        // Check if Alpine.js is loaded
        if (typeof Alpine === 'undefined') {
            console.error('‚ùå Alpine.js not loaded!');
        } else {
            debug('Alpine.js loaded');
    }

    // Log initial cart state from localStorage
    const savedCart = localStorage.getItem('dimaCart');
    debug('Initial Cart State', savedCart ? JSON.parse(savedCart) : 'No cart found');
    
    // Set up search functionality
    setupSearch();
    
    // Attach event listeners to product buttons
    attachProductButtonListeners();          opacity: 1;
            transform: translateY(0);
        }
    }

    .notification-toast {
        animation: fadeInUp 0.3s ease-out;
    }

    /* Product card and text styles */
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Smooth hover effects for product cards */
    .group:hover .group-hover\:scale-110 {
        transform: scale(1.1);
    }

    /* Custom scrollbar for horizontal scroll on mobile if needed */
    ::-webkit-scrollbar {
        height: 6px;
    }

    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    /* Responsive font scaling */
    @media (max-width: 640px) {
        html {
            font-size: 14px;
        }
    }

    /* Animation for wishlist button */
    @keyframes heartbeat {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }

    .add-to-wishlist-btn:active svg {
        animation: heartbeat 0.3s ease-in-out;
    }

    /* Loading skeleton animation (optional - for when products are loading) */
    @keyframes shimmer {
        0% {
            background-position: -468px 0;
        }
        100% {
            background-position: 468px 0;
        }
    }

    .skeleton {
        animation-duration: 1.25s;
        animation-fill-mode: forwards;
        animation-iteration-count: infinite;
        animation-name: shimmer;
        animation-timing-function: linear;
        background: linear-gradient(to right, #f6f7f8 0%, #edeef1 20%, #f6f7f8 40%, #f6f7f8 100%);
        background-repeat: no-repeat;
        background-size: 800px 100%;
    }
</style>

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Hero Banner Section -->
    <!-- Replace your existing Hero Banner Section with this -->
    <!-- Banner Carousel Section -->
    <section class="mb-12">
        {% if banners %}
        <div class="relative w-full h-64 sm:h-80 md:h-96 rounded-lg overflow-hidden shadow-lg">
            <!-- Banner Slides Container -->
            <div class="relative w-full h-full">
                {% for banner in banners %}
                <div class="banner-slide {% if forloop.first %}active{% endif %} absolute inset-0">
                    <div class="relative w-full h-full">
                        <img 
                            src="{{ banner.image }}" 
                            alt="{{ banner.title }}" 
                            class="w-full h-full object-cover"
                            loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
                            onerror="this.src='https://via.placeholder.com/1200x400/6366f1/ffffff?text=Banner+Image'"
                        >
                        <div class="banner-overlay absolute inset-0"></div>
                        <div class="absolute inset-0 flex items-center justify-center text-white">
                            <div class="text-center px-4 max-w-lg content-animate">
                                <h2 class="text-2xl sm:text-3xl md:text-4xl font-bold mb-2 sm:mb-4">{{ banner.title }}</h2>
                                {% if banner.subtitle %}
                                <p class="text-sm sm:text-base md:text-lg mb-3 sm:mb-6 opacity-90">{{ banner.subtitle }}</p>
                                {% endif %}
                                {% if banner.link_url and banner.link_text %}
                                <a 
                                    href="{{ banner.link_url }}" 
                                    class="inline-block bg-white text-gray-900 px-4 py-2 sm:px-6 sm:py-3 rounded-lg font-semibold hover:bg-gray-100 transition duration-300 text-sm sm:text-base transform hover:scale-105"
                                >
                                    {{ banner.link_text }}
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            {% if banners|length > 1 %}
            <!-- Navigation Arrows -->
            <button 
                id="prevBtn" 
                class="absolute left-2 sm:left-4 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-30 hover:bg-opacity-50 text-white p-2 rounded-full transition duration-300 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50"
                aria-label="Previous banner"
            >
                <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            
            <button 
                id="nextBtn" 
                class="absolute right-2 sm:right-4 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-30 hover:bg-opacity-50 text-white p-2 rounded-full transition duration-300 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50"
                aria-label="Next banner"
            >
                <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>

            <!-- Indicators -->
            <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-2">
                {% for banner in banners %}
                <button 
                    class="indicator w-2 h-2 sm:w-3 sm:h-3 rounded-full bg-white bg-opacity-50 {% if forloop.first %}active{% endif %}" 
                    data-slide="{{ forloop.counter0 }}"
                    aria-label="Go to slide {{ forloop.counter }}"
                ></button>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% else %}
        <!-- Fallback if no banners -->
        <div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg p-8 text-white">
            <h1 class="text-4xl font-bold mb-4">Welcome to Our Marketplace</h1>
            <p class="text-xl mb-6">Discover amazing products from trusted vendors</p>
            <a href="#products" class="bg-white text-blue-600 px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition duration-300">Shop Now</a>
        </div>
        {% endif %}
    </section>

    <style>
    .banner-slide {
        transform: translateX(100%);
        opacity: 0;
        transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .banner-slide.active {
        transform: translateX(0);
        opacity: 1;
    }

    .banner-slide.prev {
        transform: translateX(-100%);
        opacity: 0;
    }

    .indicator {
        transition: all 0.3s ease;
    }

    .indicator.active {
        background-color: white !important;
        transform: scale(1.2);
    }

    .banner-overlay {
        background: linear-gradient(135deg, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.2) 100%);
    }

    @keyframes slideIn {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .content-animate {
        animation: slideIn 0.8s ease-out 0.3s both;
    }

    /* Mobile-first responsive adjustments */
    @media (max-width: 640px) {
        .banner-slide h2 {
            font-size: 1.5rem;
        }
        
        .banner-slide p {
            font-size: 0.875rem;
        }
    }
    </style>

    <script>
    class BannerCarousel {
        constructor() {
            this.slides = document.querySelectorAll('.banner-slide');
            this.indicators = document.querySelectorAll('.indicator');
            this.prevBtn = document.getElementById('prevBtn');
            this.nextBtn = document.getElementById('nextBtn');
            this.currentSlide = 0;
            this.totalSlides = this.slides.length;
            this.autoPlayInterval = null;
            this.autoPlayDelay = 4500; // 4.5 seconds
            
            this.init();
        }
        
        init() {
            if (this.totalSlides <= 1) return;
            
            // Add event listeners
            if (this.prevBtn) this.prevBtn.addEventListener('click', () => this.prevSlide());
            if (this.nextBtn) this.nextBtn.addEventListener('click', () => this.nextSlide());
            
            // Indicator clicks
            this.indicators.forEach((indicator, index) => {
                indicator.addEventListener('click', () => this.goToSlide(index));
            });
            
            // Touch/swipe support
            this.addTouchSupport();
            
            // Start autoplay
            this.startAutoPlay();
            
            // Pause on hover (desktop only)
            if (window.innerWidth > 768) {
                const carousel = document.querySelector('section [class*="relative w-full h-"]');
                if (carousel) {
                    carousel.addEventListener('mouseenter', () => this.pauseAutoPlay());
                    carousel.addEventListener('mouseleave', () => this.startAutoPlay());
                }
            }
        }
        
        addTouchSupport() {
            let startX = 0;
            let endX = 0;
            const carousel = document.querySelector('section [class*="relative w-full h-"]');
            
            if (!carousel) return;
            
            carousel.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
            });
            
            carousel.addEventListener('touchend', (e) => {
                endX = e.changedTouches[0].clientX;
                this.handleSwipe(startX, endX);
            });
        }
        
        handleSwipe(startX, endX) {
            const threshold = 50;
            const diff = startX - endX;
            
            if (Math.abs(diff) > threshold) {
                if (diff > 0) {
                    this.nextSlide();
                } else {
                    this.prevSlide();
                }
            }
        }
        
        goToSlide(index) {
            if (index === this.currentSlide) return;
            
            // Remove active class from current slide
            this.slides[this.currentSlide].classList.remove('active');
            this.slides[this.currentSlide].classList.add('prev');
            if (this.indicators[this.currentSlide]) {
                this.indicators[this.currentSlide].classList.remove('active');
            }
            
            // Update current slide
            this.currentSlide = index;
            
            // Activate new slide
            setTimeout(() => {
                this.slides.forEach((slide, i) => {
                    slide.classList.remove('active', 'prev');
                    if (i === this.currentSlide) {
                        slide.classList.add('active');
                    }
                });
                if (this.indicators[this.currentSlide]) {
                    this.indicators[this.currentSlide].classList.add('active');
                }
            }, 50);
        }
        
        nextSlide() {
            const nextIndex = (this.currentSlide + 1) % this.totalSlides;
            this.goToSlide(nextIndex);
        }
        
        prevSlide() {
            const prevIndex = (this.currentSlide - 1 + this.totalSlides) % this.totalSlides;
            this.goToSlide(prevIndex);
        }
        
        startAutoPlay() {
            this.pauseAutoPlay();
            this.autoPlayInterval = setInterval(() => {
                this.nextSlide();
            }, this.autoPlayDelay);
        }
        
        pauseAutoPlay() {
            if (this.autoPlayInterval) {
                clearInterval(this.autoPlayInterval);
                this.autoPlayInterval = null;
            }
        }
    }

    // Initialize carousel when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
        new BannerCarousel();
    });

    // Reinitialize if page content changes (for SPA-like behavior)
    if (typeof window !== 'undefined') {
        window.initBannerCarousel = () => new BannerCarousel();
    }
    </script>

    <!-- Search Section -->
    <section class="mb-12">
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-2xl font-semibold mb-4">Find what you're looking for</h2>
            <form id="search-form" class="flex">
                <input type="text" placeholder="Search products or vendors..." class="flex-grow px-4 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button type="submit" class="bg-blue-500 text-white px-6 py-2 rounded-r-lg hover:bg-blue-600 transition duration-300">Search</button>
            </form>
            <div id="search-suggestions" class="mt-2 hidden bg-white border border-gray-200 rounded-lg shadow-lg"></div>
        </div>
    </section>

    <!-- Categories Section -->
    <section class="mb-8" id="categories">
        <h2 class="text-xl font-semibold mb-4 px-2">Browse Categories</h2>
        <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-2 px-2">
            {% if categories %}
                {% for category in categories %}
                    <a href="/products/?category={{ category.slug }}" class="relative group bg-white rounded-lg shadow-sm overflow-hidden">
                        <div class="aspect-square bg-gray-50">
                            {% if category.image %}
                                <img src="{{ BASE_URL|slice:':-4' }}{{ category.image.url }}"
                                     alt="{{ category.image.alt_text|default:category.name }}"
                                     class="w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-300"
                                     loading="lazy">
                            {% else %}
                                <div class="w-full h-full bg-gray-100 flex flex-col items-center justify-center p-2">
                                    <svg class="w-6 h-6 text-gray-400 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                </div>
                            {% endif %}
                        </div>
                        <div class="absolute inset-0 bg-gradient-to-t from-black/50 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        <div class="p-2 text-center bg-white">
                            <h3 class="text-xs font-medium text-gray-700 truncate">{{ category.name }}</h3>
                        </div>
                    </a>
                {% endfor %}
            {% else %}
                <p class="text-gray-500">No categories available.</p>
            {% endif %}
        </div>
    </section>

<!-- Trending Products Section -->
    <section class="px-4 sm:px-6 lg:px-8 py-8 sm:py-12 lg:py-16 max-w-[1400px] mx-auto" id="products">
        <!-- Section Header -->
        <div class="mb-8 sm:mb-10 lg:mb-12">
            <h2 class="text-2xl sm:text-3xl lg:text-4xl font-bold tracking-tight text-gray-900" style="font-family: 'Space Grotesk', sans-serif;">
                Trending Products
            </h2>
            <div class="mt-2 h-1 w-20 bg-gradient-to-r from-amber-400 to-amber-600 rounded-full"></div>
        </div>

        <!-- Products Grid -->
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3 sm:gap-4 lg:gap-5">
            {% if trending_products %}
                {% for product in trending_products %}
                <a href="/products/{{ product.slug }}/" class="group block">
                    <div class="bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow duration-200 border border-gray-100 h-full flex flex-col">
                        <!-- Image Container with Fixed Aspect Ratio -->
                        <div class="relative aspect-square bg-gray-50 overflow-hidden">
                            {% if product.images %}
                                {% with primary_image=product.images|first %}
                                    {% if primary_image.thumbnail_url %}
                                        <img src="{{ primary_image.thumbnail_url }}" 
                                            alt="{{ product.name }}" 
                                            class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                                            loading="lazy">
                                    {% elif primary_image.medium_url %}
                                        <img src="{{ primary_image.medium_url }}" 
                                            alt="{{ product.name }}" 
                                            class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                                            loading="lazy">
                                    {% elif primary_image.original %}
                                        <img src="{{ primary_image.original }}" 
                                            alt="{{ product.name }}" 
                                            class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                                            loading="lazy">
                                    {% endif %}
                                {% endwith %}
                            {% else %}
                                <div class="flex items-center justify-center h-full">
                                    <svg class="w-8 h-8 sm:w-12 sm:h-12 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                </div>
                            {% endif %}
                            
                            <!-- Discount Badge -->
                            {% if product.discount_percentage > 0 %}
                            <div class="absolute top-2 left-2">
                                <span class="bg-red-500 text-white text-xs font-semibold px-2 py-1 rounded-md">
                                    -{{ product.discount_percentage|floatformat:0 }}%
                                </span>
                            </div>
                            {% endif %}

                            <!-- Wishlist Button -->
                            <button class="add-to-wishlist-btn absolute top-2 right-2 p-1.5 sm:p-2 bg-white/80 backdrop-blur-sm rounded-full shadow-sm hover:bg-white hover:shadow-md transition-all duration-200" 
                                    data-product-id="{{ product.id }}"
                                    onclick="event.preventDefault(); event.stopPropagation();">
                                <svg xmlns="http://www.w3.org/2000/svg" 
                                    class="h-4 w-4 text-gray-600 hover:text-red-500 transition-colors duration-200" 
                                    fill="none" 
                                    viewBox="0 0 24 24" 
                                    stroke="currentColor"
                                    stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                </svg>
                            </button>
                        </div>

                        <!-- Product Details -->
                        <div class="p-3 sm:p-4 flex flex-col flex-grow">
                            <!-- Product Name -->
                            <h3 class="font-medium text-gray-900 text-sm leading-tight mb-2 line-clamp-2 flex-grow">
                                {{ product.name }}
                            </h3>

                            <!-- Rating (Hidden on mobile to save space) -->
                            <div class="hidden sm:flex items-center gap-1 mb-2">
                                <div class="flex items-center">
                                    {% with rating=product.avg_rating|default:0 %}
                                    {% for i in "12345" %}
                                        {% if forloop.counter <= rating %}
                                            <svg class="w-3 h-3 text-amber-400 fill-current" viewBox="0 0 20 20">
                                                <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                                            </svg>
                                        {% elif forloop.counter|add:"-1" < rating and rating < forloop.counter %}
                                            <svg class="w-3 h-3 text-amber-400" viewBox="0 0 20 20">
                                                <defs>
                                                    <linearGradient id="half-{{ product.id }}-{{ forloop.counter }}">
                                                        <stop offset="50%" stop-color="currentColor"/>
                                                        <stop offset="50%" stop-color="transparent"/>
                                                    </linearGradient>
                                                </defs>
                                                <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z" 
                                                    fill="url(#half-{{ product.id }}-{{ forloop.counter }})" 
                                                    stroke="currentColor" 
                                                    stroke-width="1"/>
                                            </svg>
                                        {% else %}
                                            <svg class="w-3 h-3 text-amber-400" viewBox="0 0 20 20">
                                                <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z" 
                                                    fill="none" 
                                                    stroke="currentColor" 
                                                    stroke-width="1"/>
                                            </svg>
                                        {% endif %}
                                    {% endfor %}
                                    {% endwith %}
                                </div>
                                <span class="text-xs text-gray-500">
                                    {{ product.avg_rating|floatformat:1 }} ({{ product.review_count }})
                                </span>
                            </div>

                            <!-- Price -->
                            <div class="flex items-baseline gap-1 mb-3">
                                <span class="text-base sm:text-lg font-bold text-gray-900">
                                    Ksh {{ product.effective_price|floatformat:0 }}
                                </span>
                                {% if product.discount_percentage > 0 %}
                                <span class="text-xs text-gray-400 line-through">
                                    Ksh {{ product.price }}
                                </span>
                                {% endif %}
                            </div>

                            <!-- Add to Cart Button -->
                            <button class="add-to-cart-btn w-full bg-gray-900 hover:bg-gray-800 text-white font-medium py-2 px-3 rounded-lg transition-colors duration-200 text-sm flex items-center justify-center gap-2 mt-auto"
                                    data-product-id="{{ product.id }}"
                                    onclick="event.preventDefault(); event.stopPropagation();">
                                <svg xmlns="http://www.w3.org/2000/svg" 
                                    class="h-4 w-4" 
                                    fill="none" 
                                    viewBox="0 0 24 24" 
                                    stroke="currentColor"
                                    stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5-5M7 13l-2.5 5M17 21a2 2 0 100-4 2 2 0 000 4zM9 21a2 2 0 100-4 2 2 0 000 4z" />
                                </svg>
                                <span class="hidden sm:inline">Add to Cart</span>
                                <span class="sm:hidden">Add</span>
                            </button>
                        </div>
                    </div>
                </a>
                {% endfor %}
            {% else %}
                <!-- Empty State -->
                <div class="col-span-full flex flex-col items-center justify-center py-12 px-4">
                    <svg class="w-16 h-16 sm:w-20 sm:h-20 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                    </svg>
                    <p class="text-gray-500 text-center max-w-md text-sm sm:text-base">
                        No trending products available at the moment. Check back soon for exciting new items!
                    </p>
                </div>
            {% endif %}
        </div>

        <style>
        /* Ensure consistent line clamping */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Custom aspect ratio for images */
        .pb-\[100\%\] {
            padding-bottom: 100%;
        }

        /* Professional font stack */
        body, * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', system-ui, sans-serif;
            font-weight: 400;
        }
        </style>
    </section>



    <!-- Featured Vendors Section -->
    <section class="mb-12">
        <h2 class="text-2xl font-semibold mb-6">Featured Vendors</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% if top_vendors %}
                {% for vendor in top_vendors %}
                <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-300">
                    <div class="flex items-center mb-4">
                        <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mr-4">
                            <span class="text-gray-500 text-2xl font-bold">{{ vendor.name.0 }}</span>
                        </div>
                        <div>
                            <h3 class="font-semibold">{{ vendor.name }}</h3>
                            {% if vendor.is_verified %}
                                <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded">Verified</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span>Rating: {{ vendor.avg_rating|floatformat:1 }}/5</span>
                        <span>{{ vendor.review_count }} reviews</span>
                    </div>
                    <div class="text-sm text-gray-600 mb-4">
                        <p>{{ vendor.product_count }} products</p>
                        <p class="mt-1">Response Time: {{ vendor.response_time }}</p>
                        <p>Completion Rate: {{ vendor.completion_rate }}%</p>
                    </div>
                    <a href="/vendors/{{ vendor.slug }}/" class="block text-center bg-gray-100 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-200 transition duration-300">View Store</a>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-gray-500">No featured vendors available.</p>
            {% endif %}
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Cache configuration
const CACHE_CONFIG = {
    trending_products: {
        duration: 5 * 60 * 1000,  // 5 minutes
        version: '1.0'
    },
    categories: {
        duration: 30 * 60 * 1000, // 30 minutes
        version: '1.0'
    },
    vendors: {
        duration: 15 * 60 * 1000, // 15 minutes
        version: '1.0'
    }
};

// Cache management functions
function setCachedData(key, data) {
    const cacheItem = {
        data: data,
        timestamp: new Date().getTime(),
        version: CACHE_CONFIG[key]?.version || '1.0'
    };
    try {
        localStorage.setItem(key, JSON.stringify(cacheItem));
        
        // Update cache status indicator
        updateCacheStatus(key, true);
    } catch (e) {
        // Handle localStorage quota exceeded
        if (e.name === 'QuotaExceededError') {
            clearOldCache();
            try {
                localStorage.setItem(key, JSON.stringify(cacheItem));
            } catch (retryError) {
                console.error('Failed to cache data even after clearing:', retryError);
            }
        }
    }
}

function getCachedData(key) {
    const cachedItem = localStorage.getItem(key);
    if (!cachedItem) return null;

    try {
        const item = JSON.parse(cachedItem);
        const now = new Date().getTime();
        const config = CACHE_CONFIG[key] || { duration: 5 * 60 * 1000, version: '1.0' };
        
        // Check version and expiration
        if (item.version !== config.version || 
            now - item.timestamp > config.duration) {
            localStorage.removeItem(key);
            updateCacheStatus(key, false);
            return null;
        }
        
        updateCacheStatus(key, true);
        return item.data;
    } catch (e) {
        console.error('Error reading cache:', e);
        localStorage.removeItem(key);
        updateCacheStatus(key, false);
        return null;
    }
}

// Cache management utilities
function clearOldCache() {
    const keys = Object.keys(localStorage);
    const now = new Date().getTime();
    
    keys.forEach(key => {
        try {
            const item = JSON.parse(localStorage.getItem(key));
            if (item.timestamp && now - item.timestamp > 24 * 60 * 60 * 1000) { // 24 hours
                localStorage.removeItem(key);
            }
        } catch (e) {
            // Skip non-JSON items
        }
    });
}

function clearAllCache() {
    Object.keys(CACHE_CONFIG).forEach(key => {
        localStorage.removeItem(key);
        updateCacheStatus(key, false);
    });
    showNotification('Cache cleared successfully');
}

function updateCacheStatus(key, isCached) {
    const indicator = document.querySelector(`[data-cache-indicator="${key}"]`);
    if (indicator) {
        indicator.classList.toggle('cached', isCached);
        indicator.title = isCached ? 
            `Cached at ${new Date().toLocaleTimeString()}` : 
            'Not cached';
    }
}

// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
    // Set up search functionality
    setupSearch();
    
    // Attach event listeners to product buttons
    attachProductButtonListeners();
    
    // Cache trending products data
    const productsData = document.querySelector('#products').innerHTML;
    if (productsData) {
        setCachedData('trending_products_html', productsData);
    }
    
    // Cache categories data
    const categoriesData = document.querySelector('#categories').innerHTML;
    if (categoriesData) {
        setCachedData('categories_html', categoriesData);
    }
    
    // Cache vendors data if they exist
    const vendorsSection = document.querySelector('.featured-vendors');
    if (vendorsSection) {
        setCachedData('vendors_html', vendorsSection.innerHTML);
    }
});

// Function to set up search functionality
function setupSearch() {
    const searchForm = document.getElementById('search-form');
    const searchInput = searchForm.querySelector('input');
    const suggestionsContainer = document.getElementById('search-suggestions');
    
    // Handle form submission
    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const query = searchInput.value.trim();
        if (query) {
            window.location.href = `/search/?q=${encodeURIComponent(query)}`;
        }
    });
    
    // Handle input for search suggestions
    searchInput.addEventListener('input', debounce(function() {
        const query = searchInput.value.trim();
        
        if (query.length < 2) {
            suggestionsContainer.classList.add('hidden');
            return;
        }
        
        fetch(`/api/search/suggestions/?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(suggestions => {
                if (suggestions && suggestions.length > 0) {
                    let suggestionsHtml = '<ul class="py-2">';
                    suggestions.forEach(suggestion => {
                        suggestionsHtml += `<li class="px-4 py-2 hover:bg-gray-100 cursor-pointer">${suggestion}</li>`;
                    });
                    suggestionsHtml += '</ul>';
                    
                    suggestionsContainer.innerHTML = suggestionsHtml;
                    suggestionsContainer.classList.remove('hidden');
                    
                    // Add click event to suggestions
                    suggestionsContainer.querySelectorAll('li').forEach(item => {
                        item.addEventListener('click', function() {
                            searchInput.value = this.textContent;
                            suggestionsContainer.classList.add('hidden');
                            searchForm.dispatchEvent(new Event('submit'));
                        });
                    });
                } else {
                    suggestionsContainer.classList.add('hidden');
                }
            })
            .catch(error => {
                console.error('Error fetching search suggestions:', error);
                suggestionsContainer.classList.add('hidden');
            });
    }, 300));
}

// Function to attach event listeners to product buttons
function attachProductButtonListeners() {
    // Add to cart buttons
    const cartButtons = document.querySelectorAll('.add-to-cart-btn');

    cartButtons.forEach(button => {
        // Remove any existing listeners to prevent duplicates
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        
        newButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const productId = this.getAttribute('data-product-id');
            if (!productId) {
                debug('Error: No product ID on button', this);
                return;
            }
            
            addToCart(productId);
        });
    });
    
    // Add to wishlist buttons
    const wishlistButtons = document.querySelectorAll('.add-to-wishlist-btn');

    wishlistButtons.forEach(button => {
        // Remove any existing listeners
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
        
        newButton.addEventListener('click', function(e) {
            debug('Wishlist Button Clicked', {
                productId: this.getAttribute('data-product-id')
            });
            
            e.preventDefault();
            e.stopPropagation();
            
            const productId = this.getAttribute('data-product-id');
            if (!productId) {
                debug('Error: No product ID on wishlist button', this);
                return;
            }
            
            addToWishlist(productId);
        });
    });
}

// Function to add product to cart
function addToCart(productId) {
    try {
        // Verify product ID
        if (!productId) {
            throw new Error('No product ID provided');
        }
        
        // Get product details from the DOM
        const productCard = document.querySelector(`[data-product-id="${productId}"]`).closest('a');
        
        if (!productCard) {
            throw new Error(`Product card not found for ID: ${productId}`);
        }

        // Extract and log each product detail
        const nameElement = productCard.querySelector('h3');
        const priceElement = productCard.querySelector('.text-xl');
        const imageElement = productCard.querySelector('img');

        // Extract product details with error handling
        const name = nameElement?.textContent?.trim();
        const priceText = priceElement?.textContent?.trim();
        
        const price = priceText ? 
            parseFloat(priceText.replace('Ksh ', '').replace(/,/g, '').trim()) : 
            null;
            
        const image = imageElement?.src || '';
        
        // Validate extracted data
        if (!name || name.length === 0) {
            throw new Error('Product name is missing');
        }
        if (!price || isNaN(price)) {
            throw new Error(`Invalid price format: ${priceText}`);
        }

        const product = {
            id: productId,
            name,
            price,
            image,
            quantity: 1
        };
        
        // Access the Alpine.js store
        const body = document.querySelector('body');
        
        if (!body.__x) {
            throw new Error('Alpine.js data not initialized on body');
        }
        
        const marketplace = body.__x.$data;
        
        if (!marketplace || !marketplace.addToCart) {
            throw new Error('Marketplace store or addToCart method not found');
        }

        // Add to cart and verify
        marketplace.addToCart(product);
        
        // Verify cart update
        const updatedCart = JSON.parse(localStorage.getItem('dimaCart'));
        debug('Cart After Update', updatedCart);
        
        // Check if product was actually added
        const productInCart = updatedCart?.items?.some(item => item.id === productId);
        if (!productInCart) {
            debug('Warning: Product not found in cart after adding');
        }
        
        // Update UI
        updateCartUI();
        showNotification('Product added to cart', 'success');
        
    } catch (error) {
        debug('Error in addToCart', {
            error: error.message,
            stack: error.stack
        });
        showNotification(`Error: ${error.message}`, 'error');
    }
}

// Function to update cart UI elements
function updateCartUI() {
    try {
        // Update cart icon
        const cartIcon = document.querySelector('.cart-icon');
        if (cartIcon) {
            cartIcon.classList.add('animate-bounce');
            setTimeout(() => cartIcon.classList.remove('animate-bounce'), 1000);
        } else {
            debug('Warning: Cart icon not found');
        }

        // Update cart badge if exists
        const cartBadge = document.querySelector('.cart-badge');
        if (cartBadge) {
            const cartData = JSON.parse(localStorage.getItem('dimaCart'));
            const itemCount = cartData?.items?.reduce((sum, item) => sum + item.quantity, 0) || 0;
            cartBadge.textContent = itemCount;
            cartBadge.classList.toggle('hidden', itemCount === 0);
            
            debug('Cart Badge Updated', { itemCount });
        }
    } catch (error) {
        debug('Error updating cart UI', error);
    }
}

// Function to add product to wishlist
function addToWishlist(productId) {
    showNotification('Product added to wishlist!');
}

// Function to show notification
function showNotification(message, type = 'success') {
    // Remove any existing notifications
    const existingNotification = document.querySelector('.notification-toast');
    if (existingNotification) {
        existingNotification.remove();
    }

    const notification = document.createElement('div');
    notification.className = `notification-toast fixed bottom-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 flex items-center space-x-2 transform translate-y-0 transition-transform duration-300`;
    
    // Set color scheme based on notification type
    switch (type) {
        case 'error':
            notification.classList.add('bg-red-500', 'text-white');
            break;
        case 'warning':
            notification.classList.add('bg-yellow-500', 'text-white');
            break;
        case 'success':
        default:
            notification.classList.add('bg-green-500', 'text-white');
    }

    // Add icon based on type
    const icon = document.createElement('i');
    icon.setAttribute('data-feather', type === 'error' ? 'alert-circle' : 
                                    type === 'warning' ? 'alert-triangle' : 
                                    'check-circle');
    notification.appendChild(icon);

    const messageSpan = document.createElement('span');
    messageSpan.textContent = message;
    notification.appendChild(messageSpan);
    
    document.body.appendChild(notification);
    
    // Initialize Feather icon
    feather.replace();
    
    // Animate in
    requestAnimationFrame(() => {
        notification.classList.add('translate-y-0');
    });
    
    // Remove after delay
    setTimeout(() => {
        notification.classList.add('translate-y-full');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}

// Basic localStorage helpers
const storage = {
    set: function(key, value) {
        try {
            const serialized = JSON.stringify(value);
            localStorage.setItem(key, serialized);
            return true;
        } catch (error) {
            return false;
        }
    },
    
    get: function(key) {
        try {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : null;
        } catch (error) {
            return null;
        }
    },
    
    remove: function(key) {
        try {
            localStorage.removeItem(key);
            return true;
        } catch (error) {
            return false;
        }
    },
    
    clear: function() {
        try {
            localStorage.clear();
            return true;
        } catch (error) {
            return false;
        }
    }
};

// Debounce function
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Function to load sections from cache or fetch from API
async function loadSectionData(sectionId, apiEndpoint, fallbackContent) {
    const cachedData = getCachedData(`${sectionId}_html`);
    const sectionElement = document.querySelector(`#${sectionId}`);
    
    if (cachedData) {
        // Use cached data if available
        sectionElement.innerHTML = cachedData;
        attachProductButtonListeners(); // Reattach event listeners
        return;
    }
    
    try {
        const response = await fetch(apiEndpoint);
        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        
        // Update the section with new data
        if (data && Object.keys(data).length > 0) {
            // Here you would process the API data and create HTML
            // This is a simplified example - adjust according to your API response structure
            let newHtml = '';
            if (sectionId === 'products') {
                newHtml = processProductsData(data);
            } else if (sectionId === 'categories') {
                newHtml = processCategoriesData(data);
            } else if (sectionId === 'vendors') {
                newHtml = processVendorsData(data);
            }
            
            if (newHtml) {
                sectionElement.innerHTML = newHtml;
                setCachedData(`${sectionId}_html`, newHtml);
                attachProductButtonListeners(); // Reattach event listeners
            }
        }
    } catch (error) {
        console.error(`Error loading ${sectionId}:`, error);
        if (fallbackContent) {
            sectionElement.innerHTML = fallbackContent;
        }
    }
}

// Helper functions to process API data
function processProductsData(data) {
    // Transform API data into HTML - adjust according to your data structure
    return data.map(product => `
        <div class="product-card" data-product-id="${product.id}">
            <!-- Your product card HTML structure -->
        </div>
    `).join('');
}

function processCategoriesData(data) {
    // Transform API data into HTML - adjust according to your data structure
    return data.map(category => `
        <div class="category-card">
            <!-- Your category card HTML structure -->
        </div>
    `).join('');
}

function processVendorsData(data) {
    // Transform API data into HTML - adjust according to your data structure
    return data.map(vendor => `
        <div class="vendor-card">
            <!-- Your vendor card HTML structure -->
        </div>
    `).join('');
}

// Add cache control UI
function addCacheControls() {
    const controlsHtml = `
        <div class="fixed bottom-4 left-4 z-50 bg-white rounded-lg shadow-lg p-4 text-sm">
            <div class="flex items-center justify-between mb-2">
                <h3 class="font-semibold">Cache Status</h3>
                <button onclick="clearAllCache()" 
                        class="text-red-600 hover:text-red-800 text-xs">
                    Clear All
                </button>
            </div>
            <div class="space-y-2">
                <div class="flex items-center justify-between">
                    <span>Products</span>
                    <span data-cache-indicator="trending_products" 
                          class="w-3 h-3 rounded-full bg-gray-300"></span>
                </div>
                <div class="flex items-center justify-between">
                    <span>Categories</span>
                    <span data-cache-indicator="categories" 
                          class="w-3 h-3 rounded-full bg-gray-300"></span>
                </div>
                <div class="flex items-center justify-between">
                    <span>Vendors</span>
                    <span data-cache-indicator="vendors" 
                          class="w-3 h-3 rounded-full bg-gray-300"></span>
                </div>
            </div>
            <div class="mt-2 text-xs text-gray-500">
                Click section to refresh
            </div>
        </div>
    `;
    
    const controls = document.createElement('div');
    controls.innerHTML = controlsHtml;
    document.body.appendChild(controls);
    
    // Add click handlers for individual refresh
    document.querySelectorAll('[data-cache-indicator]').forEach(indicator => {
        indicator.addEventListener('click', () => {
            const key = indicator.getAttribute('data-cache-indicator');
            refreshSection(key);
        });
    });
}

// Function to refresh individual sections
async function refreshSection(key) {
    localStorage.removeItem(key);
    updateCacheStatus(key, false);
    
    // Map cache keys to section IDs and API endpoints
    const sectionMap = {
        trending_products: {
            id: 'products',
            endpoint: '/api/trending-products/'
        },
        categories: {
            id: 'categories',
            endpoint: '/api/categories/'
        },
        vendors: {
            id: 'vendors',
            endpoint: '/api/featured-vendors/'
        }
    };
    
    const section = sectionMap[key];
    if (section) {
        const element = document.querySelector(`#${section.id}`);
        if (element) {
            await loadSectionData(section.id, section.endpoint, element.innerHTML);
            showNotification(`${key.replace('_', ' ')} refreshed`);
        }
    }
}

// Initialize page with cached data or fetch from API
window.addEventListener('load', () => {
    // Add cache controls
    addCacheControls();
    
    // Load sections
    loadSectionData('products', '/api/trending-products/', document.querySelector('#products').innerHTML);
    loadSectionData('categories', '/api/categories/', document.querySelector('#categories').innerHTML);
    
    const vendorsSection = document.querySelector('.featured-vendors');
    if (vendorsSection) {
        loadSectionData('vendors', '/api/featured-vendors/', vendorsSection.innerHTML);
    }
    
    // Add keyboard shortcut for clearing cache (Ctrl+Shift+R)
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.shiftKey && e.key === 'R') {
            e.preventDefault();
            clearAllCache();
        }
    });
});
</script>
{% endblock %}